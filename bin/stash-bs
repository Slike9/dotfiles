#!/usr/bin/env ruby

require 'oj'
require 'fileutils'
load File.join(__dir__, 'stash-cookie')

project = ARGV[0] || File.basename(FileUtils.pwd)
cookie = read_stash_cookie_str
cookie_header = "Cookie: #{cookie}"
url = "https://stash.funbox.ru/rest/api/latest/projects/MTSRBT/repos/#{project}/branches?base=refs%2Fheads%2Fmaster&details=true&start=0&orderBy=MODIFICATION&limit=100"
result = %x{curl '#{url}' -H '#{cookie_header}'}

data = Oj.load(result)
abort("Errors occured: #{result}") if data['errors']

bs_info = data["values"].map do |x|
  pr_state = x.dig(
    "metadata",
    "com.atlassian.bitbucket.server.bitbucket-ref-metadata:outgoing-pull-request-metadata",
    "pullRequest",
    "state"
  )
  {id: x['id'].sub(/^refs\/heads\//, ''), pr_state: pr_state}
end

id_col_width = bs_info.map { |x| x[:id].length }.max
bs_info.each do |x|
  puts "%-#{id_col_width}{id} %{pr_state}" % x
end
