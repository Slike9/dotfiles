#!/usr/bin/env ruby

require 'sqlite3'
require 'openssl'

COOKIES_PATH = "#{ENV['HOME']}/.config/google-chrome/Default/Cookies"

if __FILE__ == $0
  at_exit do
    puts read_stash_cookie_str
  end
end

def read_stash_cookie
  db = SQLite3::Database.new(COOKIES_PATH)
  rows = db.execute <<-SQL
    SELECT name, value, encrypted_value
    FROM cookies
    WHERE host_key='stash.funbox.ru'
  SQL

  rows.map { |name, _, encrypted_value|
    {name: name, value: decrypt_cookie_value(encrypted_value)}
  }
end

def read_stash_cookie_str
  read_stash_cookie.map {|x| "#{x[:name]}=#{x[:value]}"}.join("; ")
end


def decrypt_cookie_value(encrypted_value)
  # Trim off the 'v10' that Chrome/ium prepends
  encrypted_value = encrypted_value[3..-1]

  # Default values used by both Chrome and Chromium in OSX and Linux
  salt = 'saltysalt'
  iv = ' ' * 16
  length = 16

  # On Mac, replace MY_PASS with your password from Keychain
  # On Linux, replace MY_PASS with 'peanuts'
  my_pass = 'peanuts'

  # 1003 on Mac, 1 on Linux
  iterations = 1

  key = OpenSSL::PKCS5.pbkdf2_hmac_sha1(my_pass, salt, iterations, length)

  cipher = OpenSSL::Cipher.new("AES-128-CBC")
  cipher.decrypt
  cipher.key = key
  cipher.iv = iv
  plain = cipher.update(encrypted_value)
  plain << cipher.final

  plain
end
